<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Caso 4: Evaluaci贸n Interactiva</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">

    <style>
        /* ESTILOS (IGUAL QUE EL ANTERIOR PARA MANTENER LA LNEA GRFICA) */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: system-ui, -apple-system, 'Segoe UI', sans-serif; background: #f8fafc; color: #1e293b; padding-bottom: 50px; }
        .container { max-width: 900px; margin: 0 auto; padding: 20px; }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); padding: 30px; margin-bottom: 20px; }
        
        .btn { padding: 10px 20px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; font-size: 14px; transition: all 0.2s; }
        .btn:hover { filter: brightness(1.1); transform: translateY(-1px); }
        .btn-primary { background: #0ea5e9; color: white; }
        .btn-secondary { background: #6366f1; color: white; }
        .btn-success { background: #10b981; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-outline { background: white; border: 1px solid #cbd5e1; color: #475569; }
        
        .input, .textarea { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 14px; margin-bottom: 12px; }
        .input:focus { outline: none; border-color: #0ea5e9; ring: 2px solid #bae6fd; }
        
        .login-screen { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #0f172a, #0ea5e9); padding: 20px; }
        .case-content { line-height: 1.7; color: #334155; white-space: pre-line; padding: 25px; background: #f0f9ff; border-radius: 8px; border-left: 5px solid #0ea5e9; font-size: 15px; margin-bottom: 30px; }
        
        .question-card { margin-bottom: 25px; padding: 20px; border: 1px solid #e2e8f0; border-radius: 10px; background: #fff; }
        .option-label { display: flex; align-items: center; gap: 12px; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 10px; cursor: pointer; transition: all 0.2s; }
        .option-label:hover { background: #f1f5f9; }
        .option-label.selected { background: #e0f2fe; border-color: #0ea5e9; font-weight: 500; }
        
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 700; text-transform: uppercase; }
        .badge-green { background: #dcfce7; color: #166534; }
        .badge-red { background: #fee2e2; color: #991b1b; }
        .anim-fade { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;

        // ---  CONFIGURACIN ---
        const CONFIG = {
            studentPass: "EXITO",     
            adminPass: "profesor123", // Cambia esto
            salt: "CLAVE_CASO4",      // Salt 煤nico para Caso 4
            storageKey: "results_c4"  //  AQU EST LA CLAVE DEL ARREGLO (Diferente al Caso 3)
        };

        // ---  CONTENIDO DEL CASO 4 (EDITAR AQU) ---
        const DEFAULT_CASE = {
            title: "Caso 4: [Inserta tu T铆tulo Aqu铆]",
            content: "Instrucciones para el profesor:\n\n1. Edita este texto en el c贸digo fuente (variable DEFAULT_CASE).\n2. Pega aqu铆 la narrativa de tu nuevo caso.\n3. Aseg煤rate de actualizar las preguntas abajo en la variable DEFAULT_QUESTIONS.\n\nEste es un texto de ejemplo para verificar que la 'Base de Datos' del Caso 4 funciona independientemente del Caso 3."
        };

        const DEFAULT_QUESTIONS = [
            { id: 1, type: 'multiple', question: 'Pregunta de prueba para Caso 4. Selecciona la opci贸n A:', options: ['Opci贸n A (Correcta)', 'Opci贸n B', 'Opci贸n C', 'Opci贸n D'], correct: 0, feedback: 'Muy bien, el sistema funciona.' },
            { id: 2, type: 'truefalse', question: 'V/F: 驴Este archivo guarda las notas separadas del Caso 3?', options: [], correct: true, feedback: 'Verdadero. Usamos la clave results_c4 en localStorage.' },
            { id: 3, type: 'short', question: 'Escribe la palabra "Funciona" para probar la validaci贸n de texto:', correctAnswers: ['funciona', 'si funciona', 'ok'], feedback: 'Correcto.' }
        ];

        // --- FUNCIONES AUXILIARES ---
        const generateAuthCode = (name, score, max) => {
            const cleanName = name.replace(/\s/g, '').toUpperCase().substring(0, 4);
            const raw = `${cleanName}-${score}/${max}-${CONFIG.salt}`;
            return btoa(raw).substring(0, 12).toUpperCase();
        };

        // --- APP PRINCIPAL ---
        const App = () => {
            const [view, setView] = useState('login');
            const [user, setUser] = useState({ name: '', role: '' });
            
            // Estado del Examen
            const [shuffledQuestions, setShuffledQuestions] = useState([]);
            const [answers, setAnswers] = useState({});
            const [result, setResult] = useState(null);
            
            // Estado Admin y Datos
            const [adminPassInput, setAdminPassInput] = useState('');
            const [validationInput, setValidationInput] = useState('');
            const [allResults, setAllResults] = useState([]);

            //  CARGA DE DATOS (Usando la nueva llave CONFIG.storageKey)
            useEffect(() => {
                const stored = localStorage.getItem(CONFIG.storageKey);
                if (stored) setAllResults(JSON.parse(stored));
            }, []);

            // --- LGICA ALUMNO ---
            const startExam = (name, code) => {
                if(code.toUpperCase() !== CONFIG.studentPass) return alert("C贸digo incorrecto");
                if(!name.trim()) return alert("Falta el nombre");
                
                setUser({ name, role: 'student' });
                
                // Mezcla de preguntas (Shuffle)
                const qCopy = DEFAULT_QUESTIONS.map(q => {
                    if(q.type === 'multiple') {
                        const optsWithIdx = q.options.map((o, i) => ({txt: o, idx: i}));
                        optsWithIdx.sort(() => Math.random() - 0.5);
                        return { ...q, _shuffledOpts: optsWithIdx };
                    }
                    return q;
                }).sort(() => Math.random() - 0.5);
                
                setShuffledQuestions(qCopy);
                setView('exam');
            };

            const submitExam = () => {
                if(shuffledQuestions.some(q => answers[q.id] === undefined)) {
                    if(!confirm("Hay preguntas vac铆as. 驴Enviar?")) return;
                }

                let score = 0;
                const detailedResults = shuffledQuestions.map(q => {
                    const userAns = answers[q.id];
                    let isCorrect = false;

                    if (q.type === 'multiple') {
                        const selectedOptObj = q._shuffledOpts[userAns];
                        if (selectedOptObj && selectedOptObj.idx === q.correct) isCorrect = true;
                    } 
                    else if (q.type === 'truefalse') isCorrect = userAns === q.correct;
                    else if (q.type === 'short') {
                        const cleanAns = (userAns || '').toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                        isCorrect = q.correctAnswers.some(a => cleanAns.includes(a.normalize("NFD").replace(/[\u0300-\u036f]/g, "")));
                    }

                    if(isCorrect) score++;
                    return { ...q, isCorrect, userAns };
                });

                const finalCode = generateAuthCode(user.name, score, DEFAULT_QUESTIONS.length);
                
                const finalResult = {
                    date: new Date().toLocaleString(),
                    name: user.name,
                    score,
                    total: DEFAULT_QUESTIONS.length,
                    code: finalCode,
                    details: detailedResults
                };

                setResult(finalResult);
                
                //  GUARDADO INDEPENDIENTE
                const newHistory = [...allResults, finalResult];
                setAllResults(newHistory);
                localStorage.setItem(CONFIG.storageKey, JSON.stringify(newHistory));
                
                setView('results');
            };

            // --- VISTAS ---
            if(view === 'login') {
                return (
                    <div className="login-screen">
                        <div className="card" style={{maxWidth:'400px', width:'100%'}}>
                            <div style={{textAlign:'center', marginBottom:'20px'}}>
                                <i className="ri-file-text-line" style={{fontSize:'3rem', color:'#0ea5e9'}}></i>
                                <h2 style={{marginTop:'10px'}}>Acceso Caso 4</h2>
                                <p style={{color:'#64748b'}}>Plataforma de Evaluaci贸n</p>
                            </div>
                            <form onSubmit={e => { e.preventDefault(); startExam(e.target.student.value, e.target.code.value); }}>
                                <label className="badge badge-green" style={{marginBottom:'5px', display:'inline-block'}}>Estudiante</label>
                                <input name="student" className="input" placeholder="Nombre Completo" required />
                                <input name="code" className="input" placeholder="C贸digo (EXITO)" required />
                                <button className="btn btn-primary" style={{width:'100%', justifyContent:'center'}}>Comenzar</button>
                            </form>
                            <div style={{marginTop:'30px', paddingTop:'20px', borderTop:'1px solid #f1f5f9'}}>
                                <label className="badge badge-red">Profesor</label>
                                <div style={{display:'flex', gap:'5px', marginTop:'5px'}}>
                                    <input type="password" className="input" style={{marginBottom:0}} placeholder="Contrase帽a Admin" value={adminPassInput} onChange={e=>setAdminPassInput(e.target.value)} />
                                    <button className="btn btn-secondary" onClick={() => adminPassInput === CONFIG.adminPass ? setView('admin') : alert('Error')}>Entrar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            if(view === 'exam') {
                return (
                    <div className="container anim-fade">
                        <div className="card">
                            <div style={{display:'flex', justifyContent:'space-between', marginBottom:'15px'}}>
                                <h2 style={{color:'#0284c7'}}>{DEFAULT_CASE.title}</h2>
                                <span className="badge badge-green">{user.name}</span>
                            </div>
                            <div className="case-content">{DEFAULT_CASE.content}</div>
                            {shuffledQuestions.map((q, idx) => (
                                <div key={q.id} className="question-card">
                                    <p style={{fontWeight:'bold', marginBottom:'10px'}}>{idx + 1}. {q.question}</p>
                                    {q.type === 'multiple' && q._shuffledOpts.map((opt, i) => (
                                        <div key={i} className={`option-label ${answers[q.id] === i ? 'selected' : ''}`} onClick={() => setAnswers({...answers, [q.id]: i})}>
                                            <div style={{width:'18px', height:'18px', borderRadius:'50%', border:'2px solid #cbd5e1', marginRight:'10px', background: answers[q.id] === i ? '#0ea5e9' : 'transparent'}}></div>
                                            {opt.txt}
                                        </div>
                                    ))}
                                    {q.type === 'truefalse' && (
                                        <div style={{display:'flex', gap:'10px'}}>
                                            <button className={`btn ${answers[q.id] === true ? 'btn-primary' : 'btn-outline'}`} onClick={()=>setAnswers({...answers, [q.id]: true})}>Verdadero</button>
                                            <button className={`btn ${answers[q.id] === false ? 'btn-primary' : 'btn-outline'}`} onClick={()=>setAnswers({...answers, [q.id]: false})}>Falso</button>
                                        </div>
                                    )}
                                    {q.type === 'short' && <input className="input" placeholder="Tu respuesta..." onChange={e => setAnswers({...answers, [q.id]: e.target.value})} />}
                                </div>
                            ))}
                            <button className="btn btn-success" style={{width:'100%', justifyContent:'center', padding:'15px'}} onClick={submitExam}>Finalizar Examen</button>
                        </div>
                    </div>
                );
            }

            if(view === 'results' && result) {
                return (
                    <div className="container anim-fade">
                        <div className="card" style={{textAlign:'center', borderTop:'5px solid #10b981'}}>
                            <h1>隆Terminado!</h1>
                            <div style={{fontSize:'3rem', fontWeight:'bold', margin:'20px 0', color:'#1e293b'}}>{result.score} / {result.total}</div>
                            <div style={{background:'#f1f5f9', padding:'15px', borderRadius:'8px', margin:'20px 0'}}>
                                <p style={{fontSize:'12px', fontWeight:'bold', color:'#64748b'}}>CDIGO DE VERIFICACIN</p>
                                <p style={{fontFamily:'monospace', fontSize:'20px', letterSpacing:'2px', color:'#0f172a'}}>{result.code}</p>
                            </div>
                            <div style={{textAlign:'left'}}>
                                {result.details.map((r, i) => (
                                    <div key={i} style={{padding:'10px', borderBottom:'1px solid #f1f5f9'}}>
                                        <strong style={{color: r.isCorrect ? '#10b981' : '#ef4444'}}>{r.isCorrect ? 'Correcto' : 'Incorrecto'}</strong> - P{i+1}
                                        {!r.isCorrect && <div style={{fontSize:'13px', color:'#64748b', marginTop:'4px'}}>{r.feedback}</div>}
                                    </div>
                                ))}
                            </div>
                            <button className="btn btn-outline" style={{marginTop:'20px'}} onClick={() => setView('login')}>Salir</button>
                        </div>
                    </div>
                );
            }

            if(view === 'admin') {
                const downloadCSV = () => {
                    const csv = "Fecha,Alumno,Nota,Total,Codigo\n" + allResults.map(r => `${r.date},${r.name},${r.score},${r.total},${r.code}`).join("\n");
                    const link = document.createElement("a");
                    link.href = "data:text/csv;charset=utf-8," + encodeURI(csv);
                    link.download = "notas_caso4.csv"; //  NOMBRE DEL ARCHIVO ACTUALIZADO
                    link.click();
                };

                return (
                    <div className="container anim-fade">
                        <div className="card">
                            <div style={{display:'flex', justifyContent:'space-between'}}>
                                <h1>Panel Caso 4</h1>
                                <button className="btn btn-outline" onClick={() => setView('login')}>Salir</button>
                            </div>
                            <div style={{margin:'20px 0', display:'flex', gap:'10px'}}>
                                <button className="btn btn-success" onClick={downloadCSV}>Descargar Excel (Caso 4)</button>
                                <button className="btn btn-danger" onClick={() => {if(confirm("驴Borrar notas del Caso 4?")) {localStorage.removeItem(CONFIG.storageKey); setAllResults([]);}}}>Borrar Todo</button>
                            </div>
                            <div style={{background:'#f8fafc', padding:'15px', borderRadius:'8px', marginBottom:'20px'}}>
                                <p style={{fontSize:'12px', fontWeight:'bold'}}>VALIDADOR DE CDIGO</p>
                                <div style={{display:'flex', gap:'10px', marginTop:'5px'}}>
                                    <input className="input" style={{marginBottom:0}} placeholder="Pegar c贸digo..." value={validationInput} onChange={e=>setValidationInput(e.target.value)} />
                                    <button className="btn btn-primary" onClick={()=>{ try{ atob(validationInput); alert("C贸digo V谩lido"); }catch(e){ alert("C贸digo Inv谩lido"); } }}>Verificar</button>
                                </div>
                            </div>
                            <table style={{width:'100%', borderCollapse:'collapse'}}>
                                <thead><tr style={{background:'#f1f5f9', textAlign:'left'}}><th style={{padding:'10px'}}>Fecha</th><th>Alumno</th><th>Nota</th><th>C贸digo</th></tr></thead>
                                <tbody>
                                    {allResults.slice().reverse().map((r, i) => (
                                        <tr key={i} style={{borderBottom:'1px solid #e2e8f0'}}>
                                            <td style={{padding:'10px', fontSize:'13px'}}>{r.date}</td>
                                            <td>{r.name}</td>
                                            <td><span className={`badge ${r.score >= r.total/2 ? 'badge-green' : 'badge-red'}`}>{r.score}/{r.total}</span></td>
                                            <td style={{fontFamily:'monospace', fontSize:'12px'}}>{r.code}</td>
                                        </tr>
                                    ))}
                                    {allResults.length === 0 && <tr><td colSpan="4" style={{padding:'20px', textAlign:'center'}}>Sin datos en Caso 4</td></tr>}
                                </tbody>
                            </table>
                        </div>
                    </div>
                );
            }
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
